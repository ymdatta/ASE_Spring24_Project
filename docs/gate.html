<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>gate API documentation</title>
<meta name="description" content="gate: Guess, Assess, Try the strangest thing, Expand, repeat
(c) 2023, Tim Menzies, &lt;timm@ieee.org&gt;, BSD-2 …" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>gate</code></h1>
</header>
<section id="section-intro">
<p>gate: Guess, Assess, Try the strangest thing, Expand, repeat
<br>
(c) 2023, Tim Menzies, <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#116;&#105;&#109;&#109;&#64;&#105;&#101;&#101;&#101;&#46;&#111;&#114;&#103;">&#116;&#105;&#109;&#109;&#64;&#105;&#101;&#101;&#101;&#46;&#111;&#114;&#103;</a>, BSD-2
</p>
<p>USAGE:
<br>
python3 gate.py [OPTIONS]
</p>
<p>OPTIONS:
</p>
<pre><code> -b --budget0     initial evals                   = 4  
 -B --Budget      subsequent evals                = 6   
 -c --cohen       small effect size               = .35  
 -c --confidence  statistical confidence          = .05
 -e --effectSize  non-parametric small delta      = 0.2385
 -E --Experiments number of Bootstraps            = 512
 -f --file        csv data file name              = '../data/auto93.csv'  
 -h --help        print help                      = false
 -k --k           low class frequency kludge      = 1  
 -m --m           low attribute frequency kludge  = 2  
 -s --seed        random number seed              = 31210   
 -t --todo        start up action                 = 'help'   
 -T --Top         best section                    = .5
</code></pre>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
gate: Guess, Assess, Try the strangest thing, Expand, repeat     
(c) 2023, Tim Menzies, &lt;timm@ieee.org&gt;, BSD-2  
  
USAGE:    
python3 gate.py [OPTIONS]   
  
OPTIONS:  

     -b --budget0     initial evals                   = 4  
     -B --Budget      subsequent evals                = 6   
     -c --cohen       small effect size               = .35  
     -c --confidence  statistical confidence          = .05
     -e --effectSize  non-parametric small delta      = 0.2385
     -E --Experiments number of Bootstraps            = 512
     -f --file        csv data file name              = &#39;../data/auto93.csv&#39;  
     -h --help        print help                      = false
     -k --k           low class frequency kludge      = 1  
     -m --m           low attribute frequency kludge  = 2  
     -s --seed        random number seed              = 31210   
     -t --todo        start up action                 = &#39;help&#39;   
     -T --Top         best section                    = .5   
&#34;&#34;&#34;

import re,sys,ast,math,random
from collections import Counter
from fileinput import FileInput as file_or_stdin
from stats import NUM,sk

#----------------------------------------------------------------------------------------
def isGoal(s):  return s[-1] in &#34;+-!&#34;
def isHeaven(s): return 0 if s[-1] == &#34;-&#34; else 1
def isNum(s):   return s[0].isupper() 

#----------------------------------------------------------------------------------------
class struct:
  &#34;simple struct-like class, with built-in pretty-print&#34;
  def __init__(self,**d) : self.__dict__.update(d)
  __repr__ = lambda self: o(self.__dict__, self.__class__.__name__)

#----------------------------------------------------------------------------------------
class COLS(struct):
  &#34;stores NUMs and Counters generated from list of column names&#34;
  def __init__(self,names,rows):
    self.names = names
    self.ys    = {c:isHeaven(s) for c,s in enumerate(self.names) if isGoal(s)}
    self.nums  = [c           for c,s in enumerate(self.names) if isNum(s)]
    tmp        = [[y for y in x if y !=&#34;?&#34;] for x in zip(*rows)]
    self.all   = [(NUM if c in self.nums else Counter)(a) for c,a in enumerate(tmp)]

#----------------------------------------------------------------------------------------
class DATA(struct):
  &#34;storage and processing or rows and columns&#34;
  def __init__(self, lsts, order=False):
    names,*rows = list(lsts)
    self.cols = COLS(names,rows)
    self.rows = sorted(rows, key=lambda row:self.d2h(row)) if order else rows

  def mid(self): 
    &#34;returns centroid&#34;
    return [(col.mu if c in self.cols.nums else max(col,key=col.get)) 
            for c,col in enumerate(self.cols.all)] 
  
  def small(self): 
    &#34;returns small delta from centroid&#34;
    return [(col.sd*the.cohen if c in self.cols.nums else 0)
            for c,col in enumerate(self.cols.all)]

  def clone(self, rows=[], order=False):
    &#34;return a new DATA with a similar structure to self&#34;
    return DATA([self.cols.names] + rows, order=order)  

  def d2h(self,lst):  
    &#34;Euclidean distance to a mythical best point&#34;
    return (sum(abs(w-norm(self.cols.all[c], lst[c]))**2 
                for c,w in self.cols.ys.items())/len(self.cols.ys))**.5 

  def ycols(self,row): 
    &#34;returns just the y columns&#34;
    return [row[c] for c,_ in self.cols.ys.items()]

  def like(self,row,nall,nh,m=1,k=2):
    &#34;returns how much self likes row&#34;
    def num(col,x):
      v = col.sd**2 + 10**-64
      nom = math.e**(-1*(x - col.mu)**2/(2*v)) + 10**-64
      denom = (2*math.pi*v)**.5
      return min(1, nom/(denom + 10**-64))
    def sym(col,x):
      return (col.get(x, 0) + m*prior) / (len(self.rows) + m)
    #------------------------------------------
    prior = (len(self.rows) + k) / (nall + k*nh)
    out   = math.log(prior)
    for c,x in enumerate(row):
      if x != &#34;?&#34; and c not in self.cols.ys:
        col  = self.cols.all[c]
        inc  = (sym if isinstance(col, Counter) else num)(col, x) 
        out += math.log(inc)
    return out

  def smo(self,fun=None):  
    &#34;&#34;&#34;evaluate a few, divide them into best and rest, use that
    information to guess the next most informative example to evaluate&#34;&#34;&#34;
    done, todo = self.rows[:the.budget0], self.rows[the.budget0:]
    for i in range(the.Budget):
      data1 = self.clone(done, order=True)
      n = int(len(done)**the.Top + .5)
      j = smo1(i+the.budget0,
                  self.clone(data1.rows[:n],order=True), 
                  self.clone(data1.rows[n:]),
                  len(self.rows),
                  todo,
                  fun) 
    done.append(todo.pop(j))

def smo1(i,best,rest,nall,rows,fun):
  &#34;&#34;&#34;For rows not evaluated, score how likely they belong to best,rest.
  Return the row nearest the border of best,rest&#34;&#34;&#34;
  todo,max,selected = 0,-1E300,[]
  for k,row in enumerate(rows):
    b = best.like(row,nall,2,the.m,the.k)
    r = rest.like(row,nall,2,the.m,the.k) 
    if b&gt;r: selected.append(row)
    #tmp = abs(b+r) / abs(b-r + 1E-300)
    tmp = b - r #abs(b+r) / abs(b-r + 1E-300)
    if tmp &gt; max: todo,max = k,tmp  
  if fun: fun(i,best.rows[0])
  return todo

#----------------------------------------------------------------------------------------
class THE(struct):
  &#34;Builds config from __doc__ string, maybe update it from command line&#34;
  def __init__(self,txt):
    self._help = txt
    d = {m[1]:coerce(m[2]) for m in re.finditer(r&#34;--(\w+)[^=]*=\s*(\S+)&#34;,txt)}
    self.__dict__.update(d)
    
  def cli(self):
    &#34;update settings from command line flags&#34;
    for k,v in self.__dict__.items(): 
      v = str(v)
      for c,arg in enumerate(sys.argv):
        after = &#34;&#34; if c &gt;= len(sys.argv) - 1 else sys.argv[c+1]
        if arg in [&#34;-&#34;+k[0], &#34;--&#34;+k]: 
          v = &#34;false&#34; if v==&#34;true&#34; else (&#34;true&#34; if v==&#34;false&#34; else after)
          self.__dict__[k] = coerce(v)
    if self.__dict__.get(&#34;help&#34;,False):  sys.exit(self._help)
          
#----------------------------------------------------------------------------------------
def o(d,s=&#34;&#34;): 
  &#34;pretty print for dictionary&#34;
  return s+&#34;{&#34;+(&#34;, &#34;.join([f&#34;:{k} {v}&#34; for k,v in d.items() if k[0]!=&#34;_&#34;]))+&#34;}&#34; 

def coerce(s):
  &#34;turn a string into some typed atom&#34;
  try: return ast.literal_eval(s)
  except Exception: return s

def norm(col,x):
  &#34;convert `x` to the range 0..1&#34;
  return x if x==&#34;?&#34; else (x - col.lo)/(col.hi - col.lo + 1E-30) 

def entropy(d): 
  &#34;return diversity for symbol counts&#34;
  n = sum(d.values()) 
  return -sum(v/n*math.log(v/n,2) for _,v in d.items() if v&gt;0)

def csv(file=None):
  &#34;iterator: returns rows in csv file&#34;
  with file_or_stdin(file) as src:
    for line in src:
      line = re.sub(r&#39;([\n\t\r&#34;\’ ]|#.*)&#39;, &#39;&#39;, line)
      if line: yield [coerce(s.strip()) for s in line.split(&#34;,&#34;)]

isa=isinstance

def rnds(x,n=2): 
  &#34;round a thing, or a list to a few decimal places&#34;
  if isa(x,(int,float)):  return x if int(x)==x else round(x,n)
  if isa(x,(list,tuple)): return [rnds(y,n) for y in x]
  return x

#----------------------------------------------------------------------------------------
class Eg:
  &#34;place to store demos&#34;
  _all = locals()
  def all():
    &#34;run all examples, return to operating system count of failures&#34;
    errors = [f() for s,f in Eg._all.items() if s[0] !=&#34;_&#34; and s !=&#34;all&#34;]
    sys.exit(sum(0 if x==None else x for x in errors))
    
  def nothing(): pass
  def help(): 
    &#34;print help&#34;
    print(__doc__);  

  def nums(): 
    &#34;show NUMS working&#34;
    print(NUM([x**.5 for x in range(100)]))
  
  def data():
    &#34;read rows from csv, sorted by distance to heaven&#34;
    for i,row in enumerate(DATA(csv(the.file),order=True).rows):
       if i % 30 == 0 : print(i,row)

  def likes():
    &#34;reports the likelihood of rows&#34;
    d = DATA( csv(the.file),order=True)
    for i,row in enumerate(d.rows): 
      if i % 25 == 0: 
          print(i, rnds(d.d2h(row)),
                rnds(d.like(row, 1000, 2, m=the.m, k=the.k)))

  def smos():
    &#34;example of smos&#34;
    print(the.seed)
    d=DATA(csv(the.file),order=False) 
    print(&#34;names,&#34;,d.ycols(d.cols.names))
    print(&#34;base,&#34;, rnds(d.ycols(d.mid()),2)); print(&#34;#&#34;)
    random.shuffle(d.rows) 
    d.smo(lambda i,top: print(f&#34;step{i}, &#34;,rnds(d.ycols(top),2)))
    print(&#34;#\nbest,&#34;,rnds(d.ycols( d.clone(d.rows,order=True).rows[0]),2))

  def smos20():
    print(the.seed)
    d=DATA(csv(the.file),order=False) 
    names = d.ycols(d.cols.names)
    print(&#34;names,&#34;,names)
    print(&#34;mid,&#34;, rnds(d.ycols(d.mid()),2));  
    small= d.ycols(d.small())
    print(&#34;small,&#34;, rnds(small,2)); print(&#34;#&#34;)
    random.shuffle(d.rows) 
    def delta(x): return x
    def deltas(ys): return [delta(y,small,name) for y,small,name in zip(ys,small,names)]
    d.smo(lambda i,top: print(f&#34;step{i}, &#34;,rnds(deltas(d.ycols(top)),2)))
    print(&#34;#\nbest,&#34;,rnds(d.ycols( d.clone(d.rows,order=True).rows[0]),2))

#----------------------------------------------------------------------------------------
the = THE(__doc__)
if __name__ == &#34;__main__&#34;:
  the.cli()
  random.seed(the.seed)
  print(the.todo)
  getattr(Eg, the.todo, Eg.help)()</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="gate.coerce"><code class="name flex">
<span>def <span class="ident">coerce</span></span>(<span>s)</span>
</code></dt>
<dd>
<div class="desc"><p>turn a string into some typed atom</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def coerce(s):
  &#34;turn a string into some typed atom&#34;
  try: return ast.literal_eval(s)
  except Exception: return s</code></pre>
</details>
</dd>
<dt id="gate.csv"><code class="name flex">
<span>def <span class="ident">csv</span></span>(<span>file=None)</span>
</code></dt>
<dd>
<div class="desc"><p>iterator: returns rows in csv file</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def csv(file=None):
  &#34;iterator: returns rows in csv file&#34;
  with file_or_stdin(file) as src:
    for line in src:
      line = re.sub(r&#39;([\n\t\r&#34;\’ ]|#.*)&#39;, &#39;&#39;, line)
      if line: yield [coerce(s.strip()) for s in line.split(&#34;,&#34;)]</code></pre>
</details>
</dd>
<dt id="gate.entropy"><code class="name flex">
<span>def <span class="ident">entropy</span></span>(<span>d)</span>
</code></dt>
<dd>
<div class="desc"><p>return diversity for symbol counts</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def entropy(d): 
  &#34;return diversity for symbol counts&#34;
  n = sum(d.values()) 
  return -sum(v/n*math.log(v/n,2) for _,v in d.items() if v&gt;0)</code></pre>
</details>
</dd>
<dt id="gate.isGoal"><code class="name flex">
<span>def <span class="ident">isGoal</span></span>(<span>s)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def isGoal(s):  return s[-1] in &#34;+-!&#34;</code></pre>
</details>
</dd>
<dt id="gate.isHeaven"><code class="name flex">
<span>def <span class="ident">isHeaven</span></span>(<span>s)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def isHeaven(s): return 0 if s[-1] == &#34;-&#34; else 1</code></pre>
</details>
</dd>
<dt id="gate.isNum"><code class="name flex">
<span>def <span class="ident">isNum</span></span>(<span>s)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def isNum(s):   return s[0].isupper() </code></pre>
</details>
</dd>
<dt id="gate.norm"><code class="name flex">
<span>def <span class="ident">norm</span></span>(<span>col, x)</span>
</code></dt>
<dd>
<div class="desc"><p>convert <code>x</code> to the range 0..1</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def norm(col,x):
  &#34;convert `x` to the range 0..1&#34;
  return x if x==&#34;?&#34; else (x - col.lo)/(col.hi - col.lo + 1E-30) </code></pre>
</details>
</dd>
<dt id="gate.o"><code class="name flex">
<span>def <span class="ident">o</span></span>(<span>d, s='')</span>
</code></dt>
<dd>
<div class="desc"><p>pretty print for dictionary</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def o(d,s=&#34;&#34;): 
  &#34;pretty print for dictionary&#34;
  return s+&#34;{&#34;+(&#34;, &#34;.join([f&#34;:{k} {v}&#34; for k,v in d.items() if k[0]!=&#34;_&#34;]))+&#34;}&#34; </code></pre>
</details>
</dd>
<dt id="gate.rnds"><code class="name flex">
<span>def <span class="ident">rnds</span></span>(<span>x, n=2)</span>
</code></dt>
<dd>
<div class="desc"><p>round a thing, or a list to a few decimal places</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def rnds(x,n=2): 
  &#34;round a thing, or a list to a few decimal places&#34;
  if isa(x,(int,float)):  return x if int(x)==x else round(x,n)
  if isa(x,(list,tuple)): return [rnds(y,n) for y in x]
  return x</code></pre>
</details>
</dd>
<dt id="gate.smo1"><code class="name flex">
<span>def <span class="ident">smo1</span></span>(<span>i, best, rest, nall, rows, fun)</span>
</code></dt>
<dd>
<div class="desc"><p>For rows not evaluated, score how likely they belong to best,rest.
Return the row nearest the border of best,rest</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def smo1(i,best,rest,nall,rows,fun):
  &#34;&#34;&#34;For rows not evaluated, score how likely they belong to best,rest.
  Return the row nearest the border of best,rest&#34;&#34;&#34;
  todo,max,selected = 0,-1E300,[]
  for k,row in enumerate(rows):
    b = best.like(row,nall,2,the.m,the.k)
    r = rest.like(row,nall,2,the.m,the.k) 
    if b&gt;r: selected.append(row)
    #tmp = abs(b+r) / abs(b-r + 1E-300)
    tmp = b - r #abs(b+r) / abs(b-r + 1E-300)
    if tmp &gt; max: todo,max = k,tmp  
  if fun: fun(i,best.rows[0])
  return todo</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="gate.COLS"><code class="flex name class">
<span>class <span class="ident">COLS</span></span>
<span>(</span><span>names, rows)</span>
</code></dt>
<dd>
<div class="desc"><p>stores NUMs and Counters generated from list of column names</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class COLS(struct):
  &#34;stores NUMs and Counters generated from list of column names&#34;
  def __init__(self,names,rows):
    self.names = names
    self.ys    = {c:isHeaven(s) for c,s in enumerate(self.names) if isGoal(s)}
    self.nums  = [c           for c,s in enumerate(self.names) if isNum(s)]
    tmp        = [[y for y in x if y !=&#34;?&#34;] for x in zip(*rows)]
    self.all   = [(NUM if c in self.nums else Counter)(a) for c,a in enumerate(tmp)]</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="gate.struct" href="#gate.struct">struct</a></li>
</ul>
</dd>
<dt id="gate.DATA"><code class="flex name class">
<span>class <span class="ident">DATA</span></span>
<span>(</span><span>lsts, order=False)</span>
</code></dt>
<dd>
<div class="desc"><p>storage and processing or rows and columns</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class DATA(struct):
  &#34;storage and processing or rows and columns&#34;
  def __init__(self, lsts, order=False):
    names,*rows = list(lsts)
    self.cols = COLS(names,rows)
    self.rows = sorted(rows, key=lambda row:self.d2h(row)) if order else rows

  def mid(self): 
    &#34;returns centroid&#34;
    return [(col.mu if c in self.cols.nums else max(col,key=col.get)) 
            for c,col in enumerate(self.cols.all)] 
  
  def small(self): 
    &#34;returns small delta from centroid&#34;
    return [(col.sd*the.cohen if c in self.cols.nums else 0)
            for c,col in enumerate(self.cols.all)]

  def clone(self, rows=[], order=False):
    &#34;return a new DATA with a similar structure to self&#34;
    return DATA([self.cols.names] + rows, order=order)  

  def d2h(self,lst):  
    &#34;Euclidean distance to a mythical best point&#34;
    return (sum(abs(w-norm(self.cols.all[c], lst[c]))**2 
                for c,w in self.cols.ys.items())/len(self.cols.ys))**.5 

  def ycols(self,row): 
    &#34;returns just the y columns&#34;
    return [row[c] for c,_ in self.cols.ys.items()]

  def like(self,row,nall,nh,m=1,k=2):
    &#34;returns how much self likes row&#34;
    def num(col,x):
      v = col.sd**2 + 10**-64
      nom = math.e**(-1*(x - col.mu)**2/(2*v)) + 10**-64
      denom = (2*math.pi*v)**.5
      return min(1, nom/(denom + 10**-64))
    def sym(col,x):
      return (col.get(x, 0) + m*prior) / (len(self.rows) + m)
    #------------------------------------------
    prior = (len(self.rows) + k) / (nall + k*nh)
    out   = math.log(prior)
    for c,x in enumerate(row):
      if x != &#34;?&#34; and c not in self.cols.ys:
        col  = self.cols.all[c]
        inc  = (sym if isinstance(col, Counter) else num)(col, x) 
        out += math.log(inc)
    return out

  def smo(self,fun=None):  
    &#34;&#34;&#34;evaluate a few, divide them into best and rest, use that
    information to guess the next most informative example to evaluate&#34;&#34;&#34;
    done, todo = self.rows[:the.budget0], self.rows[the.budget0:]
    for i in range(the.Budget):
      data1 = self.clone(done, order=True)
      n = int(len(done)**the.Top + .5)
      j = smo1(i+the.budget0,
                  self.clone(data1.rows[:n],order=True), 
                  self.clone(data1.rows[n:]),
                  len(self.rows),
                  todo,
                  fun) 
    done.append(todo.pop(j))</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="gate.struct" href="#gate.struct">struct</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="gate.DATA.clone"><code class="name flex">
<span>def <span class="ident">clone</span></span>(<span>self, rows=[], order=False)</span>
</code></dt>
<dd>
<div class="desc"><p>return a new DATA with a similar structure to self</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def clone(self, rows=[], order=False):
  &#34;return a new DATA with a similar structure to self&#34;
  return DATA([self.cols.names] + rows, order=order)  </code></pre>
</details>
</dd>
<dt id="gate.DATA.d2h"><code class="name flex">
<span>def <span class="ident">d2h</span></span>(<span>self, lst)</span>
</code></dt>
<dd>
<div class="desc"><p>Euclidean distance to a mythical best point</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def d2h(self,lst):  
  &#34;Euclidean distance to a mythical best point&#34;
  return (sum(abs(w-norm(self.cols.all[c], lst[c]))**2 
              for c,w in self.cols.ys.items())/len(self.cols.ys))**.5 </code></pre>
</details>
</dd>
<dt id="gate.DATA.like"><code class="name flex">
<span>def <span class="ident">like</span></span>(<span>self, row, nall, nh, m=1, k=2)</span>
</code></dt>
<dd>
<div class="desc"><p>returns how much self likes row</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def like(self,row,nall,nh,m=1,k=2):
  &#34;returns how much self likes row&#34;
  def num(col,x):
    v = col.sd**2 + 10**-64
    nom = math.e**(-1*(x - col.mu)**2/(2*v)) + 10**-64
    denom = (2*math.pi*v)**.5
    return min(1, nom/(denom + 10**-64))
  def sym(col,x):
    return (col.get(x, 0) + m*prior) / (len(self.rows) + m)
  #------------------------------------------
  prior = (len(self.rows) + k) / (nall + k*nh)
  out   = math.log(prior)
  for c,x in enumerate(row):
    if x != &#34;?&#34; and c not in self.cols.ys:
      col  = self.cols.all[c]
      inc  = (sym if isinstance(col, Counter) else num)(col, x) 
      out += math.log(inc)
  return out</code></pre>
</details>
</dd>
<dt id="gate.DATA.mid"><code class="name flex">
<span>def <span class="ident">mid</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>returns centroid</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mid(self): 
  &#34;returns centroid&#34;
  return [(col.mu if c in self.cols.nums else max(col,key=col.get)) 
          for c,col in enumerate(self.cols.all)] </code></pre>
</details>
</dd>
<dt id="gate.DATA.small"><code class="name flex">
<span>def <span class="ident">small</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>returns small delta from centroid</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def small(self): 
  &#34;returns small delta from centroid&#34;
  return [(col.sd*the.cohen if c in self.cols.nums else 0)
          for c,col in enumerate(self.cols.all)]</code></pre>
</details>
</dd>
<dt id="gate.DATA.smo"><code class="name flex">
<span>def <span class="ident">smo</span></span>(<span>self, fun=None)</span>
</code></dt>
<dd>
<div class="desc"><p>evaluate a few, divide them into best and rest, use that
information to guess the next most informative example to evaluate</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def smo(self,fun=None):  
  &#34;&#34;&#34;evaluate a few, divide them into best and rest, use that
  information to guess the next most informative example to evaluate&#34;&#34;&#34;
  done, todo = self.rows[:the.budget0], self.rows[the.budget0:]
  for i in range(the.Budget):
    data1 = self.clone(done, order=True)
    n = int(len(done)**the.Top + .5)
    j = smo1(i+the.budget0,
                self.clone(data1.rows[:n],order=True), 
                self.clone(data1.rows[n:]),
                len(self.rows),
                todo,
                fun) 
  done.append(todo.pop(j))</code></pre>
</details>
</dd>
<dt id="gate.DATA.ycols"><code class="name flex">
<span>def <span class="ident">ycols</span></span>(<span>self, row)</span>
</code></dt>
<dd>
<div class="desc"><p>returns just the y columns</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ycols(self,row): 
  &#34;returns just the y columns&#34;
  return [row[c] for c,_ in self.cols.ys.items()]</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="gate.Eg"><code class="flex name class">
<span>class <span class="ident">Eg</span></span>
</code></dt>
<dd>
<div class="desc"><p>place to store demos</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Eg:
  &#34;place to store demos&#34;
  _all = locals()
  def all():
    &#34;run all examples, return to operating system count of failures&#34;
    errors = [f() for s,f in Eg._all.items() if s[0] !=&#34;_&#34; and s !=&#34;all&#34;]
    sys.exit(sum(0 if x==None else x for x in errors))
    
  def nothing(): pass
  def help(): 
    &#34;print help&#34;
    print(__doc__);  

  def nums(): 
    &#34;show NUMS working&#34;
    print(NUM([x**.5 for x in range(100)]))
  
  def data():
    &#34;read rows from csv, sorted by distance to heaven&#34;
    for i,row in enumerate(DATA(csv(the.file),order=True).rows):
       if i % 30 == 0 : print(i,row)

  def likes():
    &#34;reports the likelihood of rows&#34;
    d = DATA( csv(the.file),order=True)
    for i,row in enumerate(d.rows): 
      if i % 25 == 0: 
          print(i, rnds(d.d2h(row)),
                rnds(d.like(row, 1000, 2, m=the.m, k=the.k)))

  def smos():
    &#34;example of smos&#34;
    print(the.seed)
    d=DATA(csv(the.file),order=False) 
    print(&#34;names,&#34;,d.ycols(d.cols.names))
    print(&#34;base,&#34;, rnds(d.ycols(d.mid()),2)); print(&#34;#&#34;)
    random.shuffle(d.rows) 
    d.smo(lambda i,top: print(f&#34;step{i}, &#34;,rnds(d.ycols(top),2)))
    print(&#34;#\nbest,&#34;,rnds(d.ycols( d.clone(d.rows,order=True).rows[0]),2))

  def smos20():
    print(the.seed)
    d=DATA(csv(the.file),order=False) 
    names = d.ycols(d.cols.names)
    print(&#34;names,&#34;,names)
    print(&#34;mid,&#34;, rnds(d.ycols(d.mid()),2));  
    small= d.ycols(d.small())
    print(&#34;small,&#34;, rnds(small,2)); print(&#34;#&#34;)
    random.shuffle(d.rows) 
    def delta(x): return x
    def deltas(ys): return [delta(y,small,name) for y,small,name in zip(ys,small,names)]
    d.smo(lambda i,top: print(f&#34;step{i}, &#34;,rnds(deltas(d.ycols(top)),2)))
    print(&#34;#\nbest,&#34;,rnds(d.ycols( d.clone(d.rows,order=True).rows[0]),2))</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="gate.Eg.all"><code class="name flex">
<span>def <span class="ident">all</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>run all examples, return to operating system count of failures</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def all():
  &#34;run all examples, return to operating system count of failures&#34;
  errors = [f() for s,f in Eg._all.items() if s[0] !=&#34;_&#34; and s !=&#34;all&#34;]
  sys.exit(sum(0 if x==None else x for x in errors))</code></pre>
</details>
</dd>
<dt id="gate.Eg.data"><code class="name flex">
<span>def <span class="ident">data</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>read rows from csv, sorted by distance to heaven</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def data():
  &#34;read rows from csv, sorted by distance to heaven&#34;
  for i,row in enumerate(DATA(csv(the.file),order=True).rows):
     if i % 30 == 0 : print(i,row)</code></pre>
</details>
</dd>
<dt id="gate.Eg.help"><code class="name flex">
<span>def <span class="ident">help</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>print help</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def help(): 
  &#34;print help&#34;
  print(__doc__);  </code></pre>
</details>
</dd>
<dt id="gate.Eg.likes"><code class="name flex">
<span>def <span class="ident">likes</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>reports the likelihood of rows</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def likes():
  &#34;reports the likelihood of rows&#34;
  d = DATA( csv(the.file),order=True)
  for i,row in enumerate(d.rows): 
    if i % 25 == 0: 
        print(i, rnds(d.d2h(row)),
              rnds(d.like(row, 1000, 2, m=the.m, k=the.k)))</code></pre>
</details>
</dd>
<dt id="gate.Eg.nothing"><code class="name flex">
<span>def <span class="ident">nothing</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def nothing(): pass</code></pre>
</details>
</dd>
<dt id="gate.Eg.nums"><code class="name flex">
<span>def <span class="ident">nums</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>show NUMS working</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def nums(): 
  &#34;show NUMS working&#34;
  print(NUM([x**.5 for x in range(100)]))</code></pre>
</details>
</dd>
<dt id="gate.Eg.smos"><code class="name flex">
<span>def <span class="ident">smos</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>example of smos</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def smos():
  &#34;example of smos&#34;
  print(the.seed)
  d=DATA(csv(the.file),order=False) 
  print(&#34;names,&#34;,d.ycols(d.cols.names))
  print(&#34;base,&#34;, rnds(d.ycols(d.mid()),2)); print(&#34;#&#34;)
  random.shuffle(d.rows) 
  d.smo(lambda i,top: print(f&#34;step{i}, &#34;,rnds(d.ycols(top),2)))
  print(&#34;#\nbest,&#34;,rnds(d.ycols( d.clone(d.rows,order=True).rows[0]),2))</code></pre>
</details>
</dd>
<dt id="gate.Eg.smos20"><code class="name flex">
<span>def <span class="ident">smos20</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def smos20():
  print(the.seed)
  d=DATA(csv(the.file),order=False) 
  names = d.ycols(d.cols.names)
  print(&#34;names,&#34;,names)
  print(&#34;mid,&#34;, rnds(d.ycols(d.mid()),2));  
  small= d.ycols(d.small())
  print(&#34;small,&#34;, rnds(small,2)); print(&#34;#&#34;)
  random.shuffle(d.rows) 
  def delta(x): return x
  def deltas(ys): return [delta(y,small,name) for y,small,name in zip(ys,small,names)]
  d.smo(lambda i,top: print(f&#34;step{i}, &#34;,rnds(deltas(d.ycols(top)),2)))
  print(&#34;#\nbest,&#34;,rnds(d.ycols( d.clone(d.rows,order=True).rows[0]),2))</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="gate.THE"><code class="flex name class">
<span>class <span class="ident">THE</span></span>
<span>(</span><span>txt)</span>
</code></dt>
<dd>
<div class="desc"><p>Builds config from <strong>doc</strong> string, maybe update it from command line</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class THE(struct):
  &#34;Builds config from __doc__ string, maybe update it from command line&#34;
  def __init__(self,txt):
    self._help = txt
    d = {m[1]:coerce(m[2]) for m in re.finditer(r&#34;--(\w+)[^=]*=\s*(\S+)&#34;,txt)}
    self.__dict__.update(d)
    
  def cli(self):
    &#34;update settings from command line flags&#34;
    for k,v in self.__dict__.items(): 
      v = str(v)
      for c,arg in enumerate(sys.argv):
        after = &#34;&#34; if c &gt;= len(sys.argv) - 1 else sys.argv[c+1]
        if arg in [&#34;-&#34;+k[0], &#34;--&#34;+k]: 
          v = &#34;false&#34; if v==&#34;true&#34; else (&#34;true&#34; if v==&#34;false&#34; else after)
          self.__dict__[k] = coerce(v)
    if self.__dict__.get(&#34;help&#34;,False):  sys.exit(self._help)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="gate.struct" href="#gate.struct">struct</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="gate.THE.cli"><code class="name flex">
<span>def <span class="ident">cli</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>update settings from command line flags</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cli(self):
  &#34;update settings from command line flags&#34;
  for k,v in self.__dict__.items(): 
    v = str(v)
    for c,arg in enumerate(sys.argv):
      after = &#34;&#34; if c &gt;= len(sys.argv) - 1 else sys.argv[c+1]
      if arg in [&#34;-&#34;+k[0], &#34;--&#34;+k]: 
        v = &#34;false&#34; if v==&#34;true&#34; else (&#34;true&#34; if v==&#34;false&#34; else after)
        self.__dict__[k] = coerce(v)
  if self.__dict__.get(&#34;help&#34;,False):  sys.exit(self._help)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="gate.struct"><code class="flex name class">
<span>class <span class="ident">struct</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"><p>simple struct-like class, with built-in pretty-print</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class struct:
  &#34;simple struct-like class, with built-in pretty-print&#34;
  def __init__(self,**d) : self.__dict__.update(d)
  __repr__ = lambda self: o(self.__dict__, self.__class__.__name__)</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="gate.COLS" href="#gate.COLS">COLS</a></li>
<li><a title="gate.DATA" href="#gate.DATA">DATA</a></li>
<li><a title="gate.THE" href="#gate.THE">THE</a></li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<center>
<p><img src="simpler.png"></p>
<p><img src="https://img.shields.io/badge/purpose-teaching-red">
<img src="https://img.shields.io/badge/task-optimization-blue">
<img src="https://img.shields.io/badge/language-python3-yellow">
<a href="https://github.com/timm/lo/blob/main/LICENSE.md"><img src="https://img.shields.io/badge/license-bsd2-green"></a>
<a href="https://github.com/timm/lo/blob/main/src/gate.py"><img height=45 src="https://iconspng.com/uploads/download-button-black.png"></a></p>
</center>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="gate.coerce" href="#gate.coerce">coerce</a></code></li>
<li><code><a title="gate.csv" href="#gate.csv">csv</a></code></li>
<li><code><a title="gate.entropy" href="#gate.entropy">entropy</a></code></li>
<li><code><a title="gate.isGoal" href="#gate.isGoal">isGoal</a></code></li>
<li><code><a title="gate.isHeaven" href="#gate.isHeaven">isHeaven</a></code></li>
<li><code><a title="gate.isNum" href="#gate.isNum">isNum</a></code></li>
<li><code><a title="gate.norm" href="#gate.norm">norm</a></code></li>
<li><code><a title="gate.o" href="#gate.o">o</a></code></li>
<li><code><a title="gate.rnds" href="#gate.rnds">rnds</a></code></li>
<li><code><a title="gate.smo1" href="#gate.smo1">smo1</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="gate.COLS" href="#gate.COLS">COLS</a></code></h4>
</li>
<li>
<h4><code><a title="gate.DATA" href="#gate.DATA">DATA</a></code></h4>
<ul class="two-column">
<li><code><a title="gate.DATA.clone" href="#gate.DATA.clone">clone</a></code></li>
<li><code><a title="gate.DATA.d2h" href="#gate.DATA.d2h">d2h</a></code></li>
<li><code><a title="gate.DATA.like" href="#gate.DATA.like">like</a></code></li>
<li><code><a title="gate.DATA.mid" href="#gate.DATA.mid">mid</a></code></li>
<li><code><a title="gate.DATA.small" href="#gate.DATA.small">small</a></code></li>
<li><code><a title="gate.DATA.smo" href="#gate.DATA.smo">smo</a></code></li>
<li><code><a title="gate.DATA.ycols" href="#gate.DATA.ycols">ycols</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="gate.Eg" href="#gate.Eg">Eg</a></code></h4>
<ul class="two-column">
<li><code><a title="gate.Eg.all" href="#gate.Eg.all">all</a></code></li>
<li><code><a title="gate.Eg.data" href="#gate.Eg.data">data</a></code></li>
<li><code><a title="gate.Eg.help" href="#gate.Eg.help">help</a></code></li>
<li><code><a title="gate.Eg.likes" href="#gate.Eg.likes">likes</a></code></li>
<li><code><a title="gate.Eg.nothing" href="#gate.Eg.nothing">nothing</a></code></li>
<li><code><a title="gate.Eg.nums" href="#gate.Eg.nums">nums</a></code></li>
<li><code><a title="gate.Eg.smos" href="#gate.Eg.smos">smos</a></code></li>
<li><code><a title="gate.Eg.smos20" href="#gate.Eg.smos20">smos20</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="gate.THE" href="#gate.THE">THE</a></code></h4>
<ul class="">
<li><code><a title="gate.THE.cli" href="#gate.THE.cli">cli</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="gate.struct" href="#gate.struct">struct</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>